<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NOVA IDs | PREMIER SYSTEM</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@200;800&display=swap');
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; background: #fff; color: #1a1a1a; font-family: 'Plus Jakarta Sans', sans-serif; overflow: hidden; }
        #spectrum-canvas { position: fixed; inset: 0; pointer-events: none; z-index: 5; filter: blur(20px); opacity: 0.5; }
        #main-container { position: relative; z-index: 20; display: flex; align-items: center; justify-content: center; height: 100vh; }
        .glass-card { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(50px); border: 1px solid #f0f0f0; padding: 45px; width: 400px; border-radius: 40px; box-shadow: 0 40px 100px rgba(0,0,0,0.06); text-align: center; }
        .crystal-input { width: 100%; padding: 16px; background: #f8f9fa; border: 1px solid #eee; border-radius: 18px; outline: none; margin-bottom: 12px; font-weight: 600; font-size: 13px; text-align: center; transition: 0.3s; }
        .crystal-input:focus { border-color: #facc15; background: #fff; }
        .prime-btn { width: 100%; padding: 16px; background: #000; color: #fff; border-radius: 18px; font-weight: 800; cursor: pointer; transition: 0.3s; letter-spacing: 1px; }
        .prime-btn:hover { background: #facc15; color: #000; }
        .hidden { display: none; }
        #msg { font-size: 10px; font-weight: 800; margin-top: 15px; text-transform: uppercase; min-height: 15px; }
        .otp-area { background: #fffdf0; border: 2px dashed #facc15; padding: 15px; border-radius: 20px; margin-bottom: 12px; }
    </style>
</head>
<body onclick="initAudio()">
    <canvas id="spectrum-canvas"></canvas>
    <div id="main-container">
        <div class="glass-card" id="card">
            <h1 class="text-3xl font-black mb-1">NOVA<span class="text-yellow-500">.</span></h1>
            <p class="text-[9px] text-gray-400 font-bold tracking-[3px] mb-8">IDENTITY MANAGEMENT</p>

            <div id="login-section">
                <input type="text" id="l-user" placeholder="USERNAME" class="crystal-input">
                <input type="password" id="l-pass" placeholder="PASSWORD" class="crystal-input">
                <button onclick="handleLogin()" class="prime-btn">AUTHENTICATE</button>
                <div class="flex justify-between mt-5 px-2">
                    <span class="text-[11px] text-gray-400 cursor-pointer hover:text-black" onclick="toggleView('reg')">Request ID</span>
                    <span class="text-[11px] text-red-500 font-bold cursor-pointer hover:underline" onclick="toggleView('forgot')">Reset</span>
                </div>
            </div>

            <div id="reg-section" class="hidden">
                <input type="text" id="r-user" placeholder="USERNAME" class="crystal-input">
                <input type="text" id="r-phone" placeholder="WHATSAPP" class="crystal-input">
                <input type="email" id="r-email" placeholder="EMAIL" class="crystal-input">
                <input type="password" id="r-pass" placeholder="PASSWORD" class="crystal-input">
                <button onclick="initiateOTP('reg')" class="prime-btn">GET OTP</button>
                <p class="mt-4 text-[11px] text-gray-400 cursor-pointer" onclick="toggleView('log')">Back</p>
            </div>

            <div id="forgot-section" class="hidden">
                <input type="email" id="f-email" placeholder="REGISTERED EMAIL" class="crystal-input">
                <button onclick="initiateOTP('forgot')" class="prime-btn">SEND CODE</button>
                <p class="mt-4 text-[11px] text-gray-400 cursor-pointer" onclick="toggleView('log')">Cancel</p>
            </div>

            <div id="otp-section" class="hidden">
                <div class="otp-area">
                    <input type="number" id="v-otp" placeholder="000000" class="crystal-input !mb-0 text-xl tracking-widest">
                </div>
                <div id="reset-pass-area" class="hidden">
                    <input type="password" id="v-newpass" placeholder="NEW PASSWORD" class="crystal-input">
                </div>
                <button id="v-confirm-btn" class="prime-btn">VERIFY IDENTITY</button>
            </div>
            
            <p id="msg"></p>
        </div>
    </div>

    <audio id="phonk" loop><source src="Phonk-32.mp4" type="audio/mp4"></audio>

    <script>
        // NEW DEPLOYMENT URL
        const GOOGLE_URL = "https://script.google.com/macros/s/AKfycbyoy9CbS-SFuTjSzDz2HMtCEeqKRXYk2S7X7yCEtO15I0GryN_qsctd3YaYRbT0hIa_/exec";

        let audioCtx, analyser, dataArray, source, currentOTP = null;

        function initAudio() {
            if (audioCtx) return;
            const audio = document.getElementById('phonk');
            audio.play().catch(() => {});
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            analyser = audioCtx.createAnalyser();
            source = audioCtx.createMediaElementSource(audio);
            source.connect(analyser); analyser.connect(audioCtx.destination);
            analyser.fftSize = 128;
            dataArray = new Uint8Array(analyser.frequencyBinCount);
            animate();
        }

        function animate() {
            requestAnimationFrame(animate);
            analyser.getByteFrequencyData(dataArray);
            const canvas = document.getElementById('spectrum-canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = window.innerWidth; canvas.height = window.innerHeight;
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            let x = 0;
            const barWidth = (canvas.width / dataArray.length) * 2;
            for (let i = 0; i < dataArray.length; i++) {
                const barHeight = dataArray[i] * 1.2;
                ctx.fillStyle = `rgba(250, 204, 21, ${barHeight/400})`;
                ctx.fillRect(x, canvas.height - barHeight, barWidth, barHeight);
                x += barWidth + 1;
            }
        }

        function toggleView(view) {
            ['login-section', 'reg-section', 'forgot-section', 'otp-section'].forEach(s => document.getElementById(s).classList.add('hidden'));
            if(view === 'log') document.getElementById('login-section').classList.remove('hidden');
            if(view === 'reg') document.getElementById('reg-section').classList.remove('hidden');
            if(view === 'forgot') document.getElementById('forgot-section').classList.remove('hidden');
            if(view === 'otp') document.getElementById('otp-section').classList.remove('hidden');
            showMsg("", "");
        }

        function showMsg(t, c) { const m = document.getElementById('msg'); m.innerText = t; m.style.color = c; }

        // Logic optimized for direct Google App Script calls
        async function initiateOTP(mode) {
            const email = (mode === 'reg') ? document.getElementById('r-email').value : document.getElementById('f-email').value;
            if(!email) return showMsg("Email is required", "red");

            showMsg("Establishing Link...", "#facc15");
            currentOTP = Math.floor(100000 + Math.random() * 900000);
            
            try {
                // Using GET for faster OTP delivery to bypass CORS issues
                await fetch(`${GOOGLE_URL}?action=send_otp&email=${email}&otp=${currentOTP}`, { mode: 'no-cors' });
                
                toggleView('otp');
                document.getElementById('reset-pass-area').classList.toggle('hidden', mode !== 'forgot');
                document.getElementById('v-confirm-btn').onclick = () => finalizeAction(mode);
                showMsg("Code dispatched to email", "green");
            } catch (e) {
                showMsg("System Congestion. Try again.", "red");
            }
        }

        async function finalizeAction(mode) {
            const userOTP = document.getElementById('v-otp').value;
            if(userOTP != currentOTP) return showMsg("Invalid verification code", "red");
            
            showMsg("Syncing Database...", "#facc15");
            
            let params = `action=${mode === 'reg' ? 'register' : 'update_password_by_email'}`;
            if(mode === 'reg') {
                params += `&username=${encodeURIComponent(document.getElementById('r-user').value)}`;
                params += `&whatsapp=${encodeURIComponent(document.getElementById('r-phone').value)}`;
                params += `&email=${encodeURIComponent(document.getElementById('r-email').value)}`;
                params += `&password=${encodeURIComponent(document.getElementById('r-pass').value)}`;
            } else {
                params += `&email=${encodeURIComponent(document.getElementById('f-email').value)}`;
                params += `&password=${encodeURIComponent(document.getElementById('v-newpass').value)}`;
            }

            try {
                await fetch(`${GOOGLE_URL}?${params}`, { mode: 'no-cors' });
                showMsg("Success! Access Updated.", "green");
                setTimeout(() => toggleView('log'), 1500);
            } catch (e) {
                showMsg("Error writing data", "red");
            }
        }

        async function handleLogin() {
            const u = document.getElementById('l-user').value;
            const p = document.getElementById('l-pass').value;
            if(!u || !p) return showMsg("Fill all fields", "red");

            showMsg("Verifying...", "#facc15");
            try {
                const res = await fetch(GOOGLE_URL);
                const users = await res.json();
                const user = users.find(x => x.username.toLowerCase() === u.toLowerCase() && x.password === p);
                
                if(user) {
                    if(user.status === "Ban") return showMsg("Account Restricted", "red");
                    showMsg("Access Granted", "green");
                    localStorage.setItem('nova_user', JSON.stringify(user));
                    setTimeout(() => window.location.href = "index.html", 800);
                } else {
                    showMsg("Invalid credentials", "red");
                }
            } catch(e) {
                showMsg("Cloud Sync Offline", "red");
            }
        }
    </script>
</body>
</html>